name: Publish to AUR

on:
  push:
    tags:
      - 'v*'

jobs:
  aur-publish:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm git openssh pacman-contrib

      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate pkgver
        id: pkgver
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          pkgver=$(git describe --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g')
          echo "pkgver=$pkgver" >> "$GITHUB_OUTPUT"

      - name: Setup SSH for AUR
        run: |
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > /root/.ssh/aur
          chmod 600 /root/.ssh/aur
          echo "Host aur.archlinux.org" > /root/.ssh/config
          echo "  IdentityFile /root/.ssh/aur" >> /root/.ssh/config
          echo "  User aur" >> /root/.ssh/config
          echo "  StrictHostKeyChecking yes" >> /root/.ssh/config
          echo "  UserKnownHostsFile /root/.ssh/known_hosts" >> /root/.ssh/config
          ssh-keyscan aur.archlinux.org > /root/.ssh/known_hosts
          chmod 644 /root/.ssh/known_hosts

      - name: Clone AUR repo
        run: |
          export HOME=/root
          git clone ssh://aur@aur.archlinux.org/bifrost-go-git.git aur

      - name: Update PKGBUILD version
        run: sed -i "s/^pkgver=.*/pkgver=${{ steps.pkgver.outputs.pkgver }}/" aur/PKGBUILD

      - name: Generate .SRCINFO
        run: |
          cd aur
          makepkg --printsrcinfo > .SRCINFO

      - name: Push to AUR
        run: |
          export HOME=/root
          cd aur
          git config user.name "devzeebo"
          git config user.email "${{ secrets.AUR_EMAIL }}"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${{ steps.pkgver.outputs.pkgver }}"
          git push
