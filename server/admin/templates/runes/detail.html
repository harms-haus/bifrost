{{if .Error}}
<div class="page-header">
  <h1>Rune Not Found</h1>
</div>
<div class="card">
  <div class="card-body">
    <p class="text-muted">{{.Error}}</p>
    <a href="/admin/runes" class="btn btn-primary">Back to Runes</a>
  </div>
</div>
{{else}}
<div class="page-header">
  <h1>{{.Data.Rune.Title}}</h1>
  <p class="text-muted">{{.Data.Rune.ID}}</p>
</div>

<div class="rune-detail">
  <div class="card">
    <div class="card-header">
      <h2>Details</h2>
      <span class="badge badge-{{.Data.Rune.Status}}">{{.Data.Rune.Status}}</span>
    </div>
    <div class="card-body">
      <dl class="dl-horizontal">
        <dt>Status</dt>
        <dd>{{.Data.Rune.Status}}</dd>
        <dt>Priority</dt>
        <dd>{{.Data.Rune.Priority}}</dd>
        {{if .Data.Rune.Claimant}}
        <dt>Claimant</dt>
        <dd>{{.Data.Rune.Claimant}}</dd>
        {{end}}
        {{if .Data.Rune.Branch}}
        <dt>Branch</dt>
        <dd>{{.Data.Rune.Branch}}</dd>
        {{end}}
        {{if .Data.Rune.ParentID}}
        <dt>Parent</dt>
        <dd><a href="/admin/runes/{{.Data.Rune.ParentID}}">{{.Data.Rune.ParentID}}</a></dd>
        {{end}}
        <dt>Created</dt>
        <dd>{{.Data.Rune.CreatedAt}}</dd>
        <dt>Updated</dt>
        <dd>{{.Data.Rune.UpdatedAt}}</dd>
      </dl>

      {{if .Data.Rune.Description}}
      <h3>Description</h3>
      <p>{{.Data.Rune.Description}}</p>
      {{end}}
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2>Dependencies</h2>
    </div>
    <div class="card-body">
      {{if .Data.Rune.Dependencies}}
      <ul class="list-unstyled">
        {{range .Data.Rune.Dependencies}}
        <li>
          <span class="badge badge-secondary">{{.Relationship}}</span>
          <a href="/admin/runes/{{.TargetID}}">{{.TargetID}}</a>
          {{if $.Data.CanTakeAction}}
          <form hx-delete="/admin/runes/{{$.Data.Rune.ID}}/dependencies" hx-target="closest .rune-detail" hx-swap="outerHTML" class="form-inline" style="display: inline;">
            <input type="hidden" name="target_id" value="{{.TargetID}}">
            <input type="hidden" name="relationship" value="{{.Relationship}}">
            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
          </form>
          {{end}}
        </li>
        {{end}}
      </ul>
      {{else}}
      <p class="text-muted">No dependencies</p>
      {{end}}

      {{if .Data.CanTakeAction}}
      <hr>
      <h3>Add Dependency</h3>
      <form hx-post="/admin/runes/{{.Data.Rune.ID}}/dependencies" hx-target="closest .rune-detail" hx-swap="outerHTML" class="form">
        <div class="form-row">
          <div class="form-group">
            <label for="target_id">Target Rune ID</label>
            <input type="text" name="target_id" id="target_id" class="form-control" placeholder="e.g., bf-1234" required>
          </div>
          <div class="form-group">
            <label for="relationship">Relationship</label>
            <select name="relationship" id="relationship" class="form-control" required>
              <option value="blocks">blocks (this blocks target)</option>
              <option value="blocked_by">blocked by (target blocks this)</option>
              <option value="relates_to">relates to</option>
              <option value="duplicates">duplicates</option>
              <option value="supersedes">supersedes (this replaces target)</option>
              <option value="replies_to">replies to</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Dependency</button>
      </form>
      {{end}}
    </div>
  </div>

  {{if .Data.Rune.Notes}}
  <div class="card">
    <div class="card-header">
      <h2>Notes</h2>
    </div>
    <div class="card-body">
      <ul class="list-unstyled">
        {{range .Data.Rune.Notes}}
        <li class="note-entry">
          <small class="text-muted">{{.CreatedAt}}</small>
          <p>{{.Text}}</p>
        </li>
        {{end}}
      </ul>
    </div>
  </div>
  {{end}}

  {{if .Data.CanTakeAction}}
  <div class="card">
    <div class="card-header">
      <h2>Edit Rune</h2>
    </div>
    <div class="card-body">
      <form hx-post="/admin/runes/{{.Data.Rune.ID}}/update" hx-target="closest .rune-detail" hx-swap="outerHTML" class="form">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" name="title" id="title" class="form-control" value="{{.Data.Rune.Title}}" placeholder="Modify to change">
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea name="description" id="description" class="form-control" rows="3" placeholder="Modify to change">{{.Data.Rune.Description}}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="priority">Priority</label>
            <select name="priority" id="priority" class="form-control">
              <option value="">Keep current</option>
              <option value="0" {{if eq .Data.Rune.Priority 0}}selected{{end}}>Unprioritized</option>
              <option value="1" {{if eq .Data.Rune.Priority 1}}selected{{end}}>Urgent</option>
              <option value="2" {{if eq .Data.Rune.Priority 2}}selected{{end}}>High</option>
              <option value="3" {{if eq .Data.Rune.Priority 3}}selected{{end}}>Normal</option>
              <option value="4" {{if eq .Data.Rune.Priority 4}}selected{{end}}>Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="branch">Branch</label>
            <input type="text" name="branch" id="branch" class="form-control" value="{{.Data.Rune.Branch}}" placeholder="Modify to change">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Update Rune</button>
      </form>
    </div>
  </div>
  <div class="card">
    <div class="card-header">
      <h2>Actions</h2>
    </div>
    <div class="card-body">
      <div class="rune-actions">
        {{if .Data.CanForge}}
        <button class="btn btn-warning" hx-post="/admin/runes/{{.Data.Rune.ID}}/forge" hx-target="closest .rune-detail" hx-swap="outerHTML">Forge</button>
        {{end}}
        {{if .Data.CanClaim}}
        <button class="btn btn-primary" hx-post="/admin/runes/{{.Data.Rune.ID}}/claim" hx-target="closest .rune-detail" hx-swap="outerHTML">Claim</button>
        {{end}}
        {{if .Data.CanFulfill}}
        <button class="btn btn-success" hx-post="/admin/runes/{{.Data.Rune.ID}}/fulfill" hx-target="closest .rune-detail" hx-swap="outerHTML">Fulfill</button>
        {{end}}
        {{if .Data.CanUnclaim}}
        <button class="btn btn-warning" hx-post="/admin/runes/{{.Data.Rune.ID}}/unclaim" hx-target="closest .rune-detail" hx-swap="outerHTML">Unclaim</button>
        {{end}}
        {{if .Data.CanSeal}}
        <button class="btn btn-secondary" hx-post="/admin/runes/{{.Data.Rune.ID}}/seal" hx-target="closest .rune-detail" hx-swap="outerHTML">Seal</button>
        {{end}}
        {{if .Data.CanShatter}}
        <button class="btn btn-danger" hx-post="/admin/runes/{{.Data.Rune.ID}}/shatter" hx-vals='{"confirm": "true"}' hx-confirm="Are you sure you want to shatter this rune? This is irreversible!" hx-target="body" hx-swap="none">Shatter</button>
        {{end}}
        {{if .Data.CanAddNote}}
        <form hx-post="/admin/runes/{{.Data.Rune.ID}}/note" hx-target="closest .rune-detail" hx-swap="outerHTML" class="form-inline">
          <input type="text" name="note" placeholder="Add a note..." class="form-control" required>
          <button type="submit" class="btn btn-primary">Add Note</button>
        </form>
        {{end}}
      </div>
    </div>
  </div>
  {{end}}
</div>

<a href="/admin/runes" class="btn btn-secondary">Back to Runes</a>
{{end}}
