<div class="page-header">
  <h1>Runes</h1>
  <p>Manage work items and tasks</p>
</div>

{{if .Data.CanTakeAction}}
<div class="card" id="create-rune-form" style="display: none;">
  <div class="card-header">
    <h2>Create New Rune</h2>
    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('create-rune-form').style.display='none'">&times; Close</button>
  </div>
  <div class="card-body">
    <form hx-post="/admin/runes/create" hx-target="#create-result" hx-swap="innerHTML" class="form form-compact">
      <div class="form-row-compact">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" name="title" id="title" class="form-control" required placeholder="Enter rune title">
        </div>
        <div class="form-group form-group-small">
          <label for="create_priority">Priority</label>
          <select name="priority" id="create_priority" class="form-control">
            <option value="0">Unprioritized</option>
            <option value="1">Urgent</option>
            <option value="2" selected>High</option>
            <option value="3">Normal</option>
            <option value="4">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Branch</label>
          <input type="text" name="branch" id="branch" class="form-control" placeholder="e.g., feat/my-feature">
        </div>
        <div class="form-group">
          <label for="parent_id">Parent ID</label>
          <input type="text" name="parent_id" id="parent_id" class="form-control" placeholder="e.g., bf-1234">
        </div>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea name="description" id="description" class="form-control" rows="3" placeholder="Optional description"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Create Rune</button>
    </form>
    <div id="create-result"></div>
  </div>
</div>
{{end}}

{{if .Data.IsAdmin}}
<div class="card">
  <div class="card-header">
    <h2>Admin Actions</h2>
  </div>
  <div class="card-body">
    <p class="text-muted">Sweep unreferenced fulfilled/sealed runes. This will permanently remove (shatter) all completed runes that have no active dependents or children.</p>
    <button class="btn btn-danger" hx-post="/admin/runes/sweep" hx-vals='{"confirm": "true"}' hx-confirm="Are you sure you want to sweep all unreferenced completed runes? This is irreversible!" hx-target="body">Sweep Completed Runes</button>
  </div>
</div>
{{end}}

<div class="card">
  <div class="card-header">
    <h2>Filters</h2>
  </div>
  <div class="card-body">
    <form method="get" class="form-inline">
      <div class="form-group">
        <label for="status">Status:</label>
        <select name="status" id="status">
          <option value="">All</option>
          <option value="draft" {{if eq .Data.StatusFilter "draft"}}selected{{end}}>Draft</option>
          <option value="open" {{if eq .Data.StatusFilter "open"}}selected{{end}}>Open</option>
          <option value="claimed" {{if eq .Data.StatusFilter "claimed"}}selected{{end}}>Claimed</option>
          <option value="fulfilled" {{if eq .Data.StatusFilter "fulfilled"}}selected{{end}}>Fulfilled</option>
          <option value="sealed" {{if eq .Data.StatusFilter "sealed"}}selected{{end}}>Sealed</option>
        </select>
      </div>
      <div class="form-group">
        <label for="priority">Priority:</label>
        <select name="priority" id="priority">
          <option value="">All</option>
          <option value="0" {{if eq .Data.PriorityFilter "0"}}selected{{end}}>Unprioritized</option>
          <option value="1" {{if eq .Data.PriorityFilter "1"}}selected{{end}}>Urgent</option>
          <option value="2" {{if eq .Data.PriorityFilter "2"}}selected{{end}}>High</option>
          <option value="3" {{if eq .Data.PriorityFilter "3"}}selected{{end}}>Normal</option>
          <option value="4" {{if eq .Data.PriorityFilter "4"}}selected{{end}}>Low</option>
        </select>
      </div>
      <div class="form-group">
        <label for="assignee">Assignee:</label>
        <input type="text" name="assignee" id="assignee" value="{{.Data.AssigneeFilter}}" placeholder="Username">
      </div>
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="/admin/runes" class="btn btn-secondary">Clear</a>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Runes ({{len .Data.Runes}})</h2>
    {{if .Data.CanTakeAction}}
    <button class="btn btn-primary btn-sm" onclick="document.getElementById('create-rune-form').style.display='block'">+ Add Rune</button>
    {{end}}
  </div>
  <div class="card-body">
    {{if .Data.Runes}}
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Assignee</th>
          <th>Branch</th>
        </tr>
      </thead>
      <tbody>
        {{range .Data.Runes}}
        <tr>
          <td><a href="/admin/runes/{{.ID}}">{{.ID}}</a></td>
          <td>{{.Title}}</td>
          <td><span class="badge badge-{{.Status}}">{{.Status}}</span></td>
          <td>{{priorityLabel .Priority}}</td>
          <td>{{.Claimant}}</td>
          <td>{{.Branch}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="text-muted">No runes found</p>
    {{end}}
  </div>
</div>
